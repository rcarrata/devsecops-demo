- name: Get ACS details from ACS secret
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: roxsecrets
    namespace: "{{ pipeline_namespace }}"
  register: acs_secret

- name: Get ACS Server URL from Secret
  ansible.builtin.set_fact:
    acs_url: "{{ acs_secret.resources.0.data.rox_central_endpoint | b64decode }}"

- name: Get ACS Token Secret
  ansible.builtin.set_fact:
    acs_token: "{{ acs_secret.resources.0.data.rox_api_token | b64decode }}"

- name: Get Cosign Secret Details
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: "{{ secret_generate_name }}"
    namespace: "{{ pipeline_namespace }}"
  register: cosign_secret

- name: Get Cosign Key from secret
  ansible.builtin.set_fact:
    cosign_key: "{{ cosign_secret.resources.0.data['cosign.key'] | b64decode | trim }}"

- name: Get Cosign Password from secret
  ansible.builtin.set_fact:
    cosign_password: "{{ cosign_secret.resources.0.data['cosign.password'] | b64decode | trim }}"

- name: Get Cosign Public Key from secret
  ansible.builtin.set_fact:
    cosign_pub: "{{ cosign_secret.resources.0.data['cosign.pub'] | b64decode | trim | replace('\n', '\\n')}}"

- name: Get list of ACS Signatures
  uri:
    url: "https://{{ acs_url}}/v1/signatureintegrations"
    headers:
      Content-Type: application/json
    method: GET
    user: admin
    password: "{{ stackrox_central_admin_password }}"
    body_format: json
    force_basic_auth: true
    validate_certs: no
  register: cosign_signature_list

- name: Filter List of Integration Names
  ansible.builtin.set_fact:
    integration_names: "{{ cosign_signature_list.json.integrations | map(attribute='name') }}"
    integration_ids: "{{ cosign_signature_list.json.integrations | map(attribute='id') }}"
  when: cosign_signature_list.json.integrations | length>0

- name: Print List of Integrations
  ansible.builtin.debug:
    msg: "{{ integration_names }}"
  when: cosign_signature_list.json.integrations | length>0

- name: Set signature ID
  ansible.builtin.set_fact:
    signature_id: "{% if item.0 == 'cosign-demo' %}{{item.1}}{% else %}''{% endif %}"
  when: cosign_signature_list.json.integrations | length>0
  loop: "{{ integration_names|zip(integration_ids)|list }}"

- name: Print signature ID
  ansible.builtin.debug:
    msg: "{{ signature_id }}"
  when: cosign_signature_list.json.integrations | length>0

- name: Add Cosign Signature to ACS
  uri:
    url: "https://{{ acs_url }}/v1/signatureintegrations"
    headers:
      Content-Type: application/json    
    body: '{"id":"","name":"cosign-demo","cosign":{"publicKeys":[{"name":"cosign-demo","publicKeyPemEnc":"{{ cosign_pub }}"}]}}'
    method: POST
    user: admin
    password: "{{ stackrox_central_admin_password }}"
    body_format: json
    force_basic_auth: true
    validate_certs: no
  register: cosign_signature_response
  when: "'cosign-demo' not in integration_names|default('')"

- name: Set signature ID
  ansible.builtin.set_fact:
    signature_id: "{{ cosign_signature_response.json.id }}"
  when: cosign_signature_response.json|default("") != ""

- name: Print signature ID
  ansible.builtin.debug:
    msg: "{{ signature_id }}"
  when: cosign_signature_response.json|default("") != ""

- name: Replace Hidden Characters
  ansible.builtin.debug:
    msg: "{{ signature_id }}"
  when: cosign_signature_response.json|default("") != ""
